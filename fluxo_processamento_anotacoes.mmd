sequenceDiagram
    participant U as üë§ Usu√°rio
    participant WA as üì± WhatsApp
    participant WH as üîó Webhook
    participant WS as üí¨ WhatsApp Service
    participant DB as üóÑÔ∏è Database
    participant Q as üì® Queue
    participant AI as ü§ñ AI Service
    participant GPT as üß† ChatGPT
    participant PX as üîé Perplexity
    participant BR as üì° Broker
    participant APP as üì± App Flutter

    Note over U,APP: Fluxo de Processamento de Anota√ß√µes

    %% Captura via WhatsApp
    U->>WA: Envia mensagem/m√≠dia
    WA->>WH: Webhook HTTP POST
    WH->>WS: Processa webhook
    
    %% Valida√ß√£o e Armazenamento
    WS->>WS: Valida assinatura
    WS->>DB: Busca usu√°rio por telefone
    alt Usu√°rio encontrado
        WS->>DB: Salva anota√ß√£o (status: pending)
        WS->>WA: Envia confirma√ß√£o
        WS->>Q: Adiciona √† fila IA
    else Usu√°rio n√£o encontrado
        WS->>WA: Solicita registro
        WS->>WS: Aguarda resposta registro
    end

    %% Processamento IA Ass√≠ncrono
    Q->>AI: Processa anota√ß√£o da fila
    AI->>GPT: Solicita categoriza√ß√£o
    GPT-->>AI: Retorna categoria + tags
    
    AI->>AI: Verifica se precisa enriquecimento
    alt Precisa contexto externo
        AI->>PX: Busca informa√ß√µes relacionadas
        PX-->>AI: Retorna contexto adicional
    end
    
    AI->>DB: Atualiza anota√ß√£o (status: processed)
    AI->>BR: Publica evento "anota√ß√£o processada"

    %% Sincroniza√ß√£o Tempo Real
    BR->>APP: Notifica nova anota√ß√£o
    APP->>APP: Atualiza interface local
    
    %% Visualiza√ß√£o pelo Usu√°rio
    U->>APP: Abre aplicativo
    APP->>DB: Busca anota√ß√µes atualizadas
    DB-->>APP: Retorna anota√ß√µes organizadas
    APP->>U: Exibe anota√ß√µes categorizadas

    Note over U,APP: Anota√ß√£o dispon√≠vel em interface organizada

